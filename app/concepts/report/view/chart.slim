body
  . style="width:80%; margin-left: 10%;"
    canvas id="canvas" style:"-moz-user-select: none; -webkit-user-select: none;-ms-user-select: none;"
  br

javascript:
  var color = Chart.helpers.color;

  function getTimeString(time) {
    return moment(time, 'mm:ss');
  }

  function getDataSet(time, yArray) {
    var array_size = yArray.length - 1;
    var data = new Array();
    for(var i=0;i < array_size; i++) {
      var obj = {
                  x: getTimeString(time[i]),
                  y: yArray[i]
                };
      data.push(obj);
    }
    return data;
  }

  var ctx = document.getElementById("canvas").getContext("2d");

  ctx.fillStyle = 'white';
  ctx.fill();

  var originalLineDraw = Chart.controllers.line.prototype.draw;
  Chart.helpers.extend(Chart.controllers.line.prototype, {
    draw: function() {
      originalLineDraw.apply(this, arguments);

      var chart = this.chart;
      var ctx = chart.chart.ctx;

      var value = chart.config.data.lineAtValue;
      if (value) {
        var xaxis = chart.scales['x-axis-0'];
        var yaxis = chart.scales['y-axis-0'];

        var from = xaxis.getPixelForValue(undefined, index);
        var to = xaxis.getPixelForValue(undefined, index);
        var at_point = xaxis.getPixelForValue(value);

        ctx.save();
        ctx.beginPath();
        ctx.moveTo(at_point, yaxis.top + 20);
        ctx.strokeStyle = '#ff0000';
        ctx.lineTo(at_point, yaxis.bottom);
        ctx.stroke();
        ctx.restore();

        // write AT
        ctx.textAlign = 'center';
        ctx.fillText("AT", at_point, yaxis.top + 5);
      }
    }
  });

  var config = {
                type: 'line',
                data: {
                    datasets: [
                    {
                      borderColor: "#000000",
                      backgroundColor: "#000000",
                      fill: false,
                      label: 'VO2 Max',
                      data:[{
                              x: getTimeString(#{vo2_max_starts}),
                              y: #{vo2_max_value}
                            },
                            {
                              x: getTimeString(#{vo2_max_ends}),
                              y: #{vo2_max_value}
                            }
                            ]
                    },
                    {
                      backgroundColor: color(window.chartColors.blue).alpha(0.5).rgbString(),
                      borderColor: window.chartColors.blue,
                      fill: false,
                      label: 'VO2',
                      data: getDataSet(#{time}, #{vo2})
                    },
                    {
                      backgroundColor: color(window.chartColors.red).alpha(0.5).rgbString(),
                      borderColor: window.chartColors.red,
                      fill: false,
                      label: 'VCO2',
                      data: getDataSet(#{time}, #{vco2})
                    },
                    {
                      backgroundColor: "#f7edca",
                      label: 'Exercise Phase',
                      pointRadius: 0,
                      data:[{
                              x: getTimeString(#{exer_phase[0]}),
                              y: #{y_exer_phase}
                            },
                            {
                              x: getTimeString(#{exer_phase[1]}),
                              y: #{y_exer_phase}
                            }
                            ]
                    }],
                    lineAtValue: getTimeString(#{at_value})
                },
                options: {
                  responsive: true,
                  backgroundColor: "#ffffff",
                  title : {
                    display: true,
                    text: 'VO2-VCO2 on time'
                  },

                  legend: {
                    display: true,
                    position: 'right'
                  },

                  scales: {
                      xAxes: [{
                          type: 'time',
                          time: {
                            unit: 'minute',
                            displayFormats: {
                              'second': 'mm:ss',
                              'minute': 'mm:ss'
                            },
                            tooltipFormat: "mm:ss"
                          },
                          position: 'bottom'
                      }]
                  }
                }
              }

  window.myLine = new Chart(ctx, config);
